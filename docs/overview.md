# 医療機関向けLINE呼び込みシステム 仕様概要

## プロジェクト概要

本プロジェクトは、医療機関における診察時の患者呼び込みをスマートフォン(LINE)を通じて行うためのシステムです。電子カルテシステムと連携し、患者のスマートフォンに診察の呼び出しメッセージを送信することで、待合室での呼び出し漏れを防ぎ、患者の利便性を向上させることを目的としています。

システムは電子カルテ端末上で動作するクライアントプログラムと、クラウド上で動作するサーバープログラム、そしてLINE Messaging APIを組み合わせて構成されています。患者は初回登録時にQRコードを読み取ることで、自身のLINEアカウントと患者情報を紐づけ、その後は診察の呼び出しをLINEメッセージとして受け取ることができます。

## システム構成

### クライアント側プログラム(電子カルテサーバー上)

クライアント側では、電子カルテシステムと連携する複数のプログラムが動作します。これらのプログラムはODBC経由でローカルデータベースにアクセスし、患者の登録状態を管理します。

**RegPatientOnKarte:** 患者のスマホ登録を行うプログラムです。電子カルテ端末の「スマホ登録」ボタンから起動され、患者情報の暗号化、QRコードの生成、登録用紙の印刷を行います。

**SendMessageOnKarte:** 診察呼び出しメッセージをクラウドサーバーに送信するプログラムです。CheckVisitプログラムから患者IDとメッセージを受け取り、クラウド側のメッセージ送信機能を呼び出します。

**CheckVisit:** 電子カルテサーバー上で常駐し、診察の進行状況を監視するプログラムです。患者の呼び出しタイミングを検知し、SendMessageOnKarteにメッセージ送信を指示します。

### サーバー側プログラム(クラウド上)

サーバー側では、患者情報の管理とLINEとの通信を担当するプログラムが動作します。これらはクラウドデータベースを使用して、患者とLINEアカウントの紐づけ情報を管理します。

**RegPatientOnCloud:** クライアント側から送信された患者登録情報を受け取り、Patientsテーブルに格納します。暗号化された患者情報を安全に保管し、後続の紐づけ処理で使用できるようにします。

**LineHook:** LINE Messaging APIのWebhookエンドポイントとして機能します。LINEからのすべてのイベント(友だち登録、メッセージ受信など)を受け取り、適切な処理を実行します。患者との紐づけ、紐づけの確認・解除などの機能を提供します。

**SendMessageOnCloud:** クライアント側から送信されたメッセージ送信要求を受け取り、LinkdPatientテーブルを検索して該当するLINEユーザーにメッセージを送信します。

### データベーステーブル

システムは以下のテーブルを使用して情報を管理します。

**RegisterdIDテーブル(ローカル):** 電子カルテサーバー上に配置され、スマホ登録済みの患者情報を管理します。患者ID、暗号化キー、登録日時などを格納し、重複登録の防止と暗号化キーの保管に使用されます。

**Patientsテーブル(クラウド):** クラウド上に配置され、登録処理中の患者情報を一時的に保管します。暗号化された患者データと登録日時を格納し、QRコード読み取り時の紐づけ処理で参照されます。

**LinkdPatientテーブル(クラウド):** クラウド上に配置され、LINEユーザーIDと患者情報の紐づけを管理します。一つのLINEアカウントに複数の患者を紐づけることが可能で、家族の診察情報などを一つのアカウントで受け取ることができます。

## 機能詳細

### 1. ユーザー登録機能

患者のスマートフォンをシステムに登録するための機能です。電子カルテ端末での操作から始まり、QRコードの生成と印刷、クラウドへのデータ送信までを自動的に行います。

#### 1.1 電子カルテ端末での登録処理

医療スタッフが電子カルテ端末で「スマホ登録」ボタンを押すと、RegPatientOnKarteプログラムが起動します。プログラムはまず、ODBC経由でRegisterdIDテーブルを検索し、現在表示されている患者がすでに登録済みかどうかを確認します。

登録済みの場合は、「この患者は既にスマホ登録されています」といったメッセージを表示してプログラムを終了します。これにより、重複登録を防止し、患者情報の整合性を保ちます。

未登録の場合は、現在電子カルテで開かれている患者のID、氏名を取得し、現在時刻をキーとして暗号化処理を行います。この暗号化されたデータは、患者のスマートフォンとシステムを安全に紐づけるための重要な情報となります。

暗号化されたデータは、クラウド上のRegPatientOnCloudプログラムに送信されます。同時に、システムは2つのQRコードを生成します。1つ目はLINE公式アカウントの友だち登録用QRコード、2つ目は暗号化されたデータと使用日時を含むメッセージ送信用QRコードです。

これらのQRコード、暗号化されていない患者氏名、登録手順の説明などをA4用紙に印刷します。この用紙は患者に渡され、患者自身でスマートフォンから登録作業を完了させるために使用されます。

最後に、患者IDと暗号化されたデータをODBC経由でRegisterdIDテーブルに書き込み、ローカル側での登録処理を完了します。

#### 1.2 クラウド側での登録データ保管

RegPatientOnCloudは、クライアント側から送信された暗号化データを受け取り、Patientsテーブルに格納します。このデータは、患者がQRコードを読み取って紐づけを完了するまでの間、一時的に保管されます。登録日時も同時に記録され、後の有効期限チェックに使用されます。

### 2. LINE友だち登録機能

患者がLINE公式アカウントと友だちになるための機能です。LINE Messaging APIのWebhook機能を使用して、友だち登録イベントを検知し、適切なガイダンスを提供します。

LINE公式アカウントのメッセージAPIには、あらかじめLineHook関数がWebhookエンドポイントとして登録されています。患者が友だち登録用QRコードを読み取ってLINE公式アカウントを友だち追加すると、LineHook関数が呼び出されます。

LineHook関数は友だち登録イベントを検知すると、お礼のメッセージとともに、次のステップとして2枚目のQRコード(メッセージ送信用QRコード)を読み込むよう案内するメッセージを送信します。このメッセージには、QRコードの読み取り方法や注意事項などが含まれます。

### 3. スマートフォンと患者の紐づけ機能

LINE友だち登録を完了した患者が、自身の患者情報とLINEアカウントを紐づけるための機能です。QRコードを読み取ることで、安全かつ簡単に紐づけを完了できます。

患者が2枚目のQRコード(メッセージ送信用QRコード)を読み取ると、暗号化されたデータと登録日時がLINEメッセージとしてLineHook関数に送信されます。QRコードには事前に設定されたメッセージテンプレートが埋め込まれており、患者は送信ボタンを押すだけで必要な情報を送信できます。

LineHook関数はメッセージを受信すると、まず登録日時をチェックします。設定ファイルで指定された時間間隔(例: 24時間)よりも古い場合は、セキュリティ上の理由から「登録期限が切れています。受付で新しいQRコードを発行してください」といった内容のメッセージをLINEに返信し、処理を終了します。

登録期限内の場合は、LINEのユーザーIDと暗号化されたコードをLinkdPatientテーブルに保存します。この時点で、患者のLINEアカウントとシステムの紐づけが完了します。

次に、暗号化されたデータから患者氏名を復号し、「○○○○さんの紐づけが完了しました。診察の呼び出しをLINEでお知らせします」といった確認メッセージを返信します。これにより、患者は正しく登録が完了したことを確認できます。

### 4. メッセージ送信機能

診察の呼び出しメッセージを患者のLINEアカウントに送信するための機能です。電子カルテシステムと連携し、適切なタイミングで患者に通知を届けます。

電子カルテサーバー上に配置されたSendMessageOnKarteプログラムは、同じくサーバー上で常駐するCheckVisitプログラムから、患者IDとメッセージ内容を受け取ります。CheckVisitプログラムは診察の進行状況を監視し、患者を呼び出すタイミングでSendMessageOnKarteにメッセージ送信を指示します。

SendMessageOnKarteは、ODBC経由でRegisterdIDテーブルを検索し、受け取った患者IDが登録されているかを確認します。見つからない場合は、「患者ID: XXXXX はスマホ登録されていません」といった内容をログファイルに記録して処理を終了します。

患者IDが見つかった場合は、同じレコードから暗号化キーを取り出し、この暗号化キーとメッセージ内容をクラウド上のSendMessageOnCloudプログラムに送信します。暗号化キーは患者を一意に識別するための情報として使用されます。

SendMessageOnCloudは、受け取った暗号化キーを使用してLinkdPatientテーブルを検索し、該当するLINEユーザーIDを特定します。一つの暗号化キーに対して複数のLINEユーザーIDが紐づいている場合(例: 家族が同じ患者情報を登録している場合)は、すべてのユーザーにメッセージを送信します。

最後に、LINE Messaging APIを使用して、特定されたLINEユーザーIDに対してメッセージを送信します。メッセージには診察室番号や待ち時間の目安などの情報が含まれます。

### 5. 紐づけの確認と解除機能

患者が自身のLINEアカウントに紐づけられている患者情報を確認し、必要に応じて紐づけを解除するための機能です。複数の患者を紐づけている場合の管理を容易にします。

#### 5.1 紐づけ確認

患者がLINEで「リスト」とメッセージを送信すると、LineHook関数はLinkdPatientテーブルを検索し、そのLINEユーザーIDに紐づけられているすべての暗号化キーを取得します。

各暗号化キーを復号して患者氏名を取得し、1番から順に連番を付与したリストとして整形します。例えば、「紐づけされている患者情報:\n1. 山田太郎\n2. 山田花子」といった形式でメッセージを返信します。これにより、患者は自分のアカウントにどの患者情報が紐づけられているかを確認できます。

#### 5.2 紐づけ解除

紐づけリストを確認した患者が、特定の患者情報の紐づけを解除したい場合、リストに表示された番号をLINEメッセージとして送信します。

LineHook関数は番号を受け取ると、該当する患者の氏名を取得し、「○○○○さんの紐づけを解除してよろしいですか？『はい』または『Yes』と返信してください」といった確認メッセージを返信します。

患者が「はい」または「Yes」と返信すると、該当する患者情報とLINEユーザーIDの紐づけレコードをLinkdPatientテーブルから削除します。削除完了後、「○○○○さんの紐づけを解除しました」という確認メッセージを送信します。

#### 5.3 解除処理のキャンセル

解除処理は慎重に行う必要があるため、以下の条件でキャンセルされます。

確認メッセージを送信してから5分以上経過した場合、タイムアウトとして解除処理をキャンセルします。この場合、患者が再度「リスト」から操作をやり直す必要があります。

また、確認待ちの状態で「はい」「Yes」以外の異なるメッセージが送信された場合も、解除処理をキャンセルします。例えば、患者が途中で「キャンセル」や「やめる」と送信した場合、または全く関係ないメッセージを送信した場合は、解除処理を中止し、通常のメッセージ処理に戻ります。

### 6. プロトタイプ用機能

本番環境の電子カルテシステムなしでシステムの動作を確認するための機能です。開発段階やデモンストレーションで使用します。

#### 6.1 テスト用患者登録機能(TestRegPatientOnKarte)

RegPatientOnKarteの代替として動作するWebベースのテストプログラムです。電子カルテシステムがない環境でも患者登録のテストを行えます。

TestRegisterdIDテーブルをクラウド上に作成し、RegisterdIDテーブルの代用として使用します。このテーブルは本番環境のテーブルとは分離されているため、テストデータが本番データに影響を与えることはありません。

Webインターフェースは、患者IDと氏名を入力するフォームを提供します。「登録」ボタンをクリックすると、RegPatientOnKarteと同様の処理(暗号化、QRコード生成、クラウドへのデータ送信)が実行されます。

生成された2つのQRコード(LINE友だち登録用とメッセージ送信用)は、同じWebページ上に表示されます。各QRコードには「ダウンロード」ボタンが付いており、画像ファイルとして保存できます。これにより、実際の運用と同様にQRコードをスマートフォンで読み取ってテストを行えます。

#### 6.2 テスト用メッセージ送信機能(TestSendMessageOnKarte)

SendMessageOnKarteとCheckVisitの代替として動作するWebベースのテストプログラムです。メッセージ送信機能を手動でテストできます。

Webインターフェースは、患者IDと送信したいメッセージ内容を入力するフォームを提供します。メッセージ内容は自由に記述でき、実際の診察呼び出しメッセージのテストや、様々なメッセージパターンの動作確認に使用できます。

「送信」ボタンをクリックすると、入力された患者IDをTestRegisterdIDテーブルで検索し、暗号化キーを取得します。その後、暗号化キーとメッセージ内容をSendMessageOnCloudに送信し、実際のメッセージ送信処理を実行します。

送信結果(成功または失敗、エラーメッセージなど)はWebページ上に表示され、テストの結果を即座に確認できます。

## セキュリティとプライバシー

本システムは医療情報を扱うため、以下のセキュリティ対策を実装しています。

患者情報は現在時刻をキーとして暗号化され、QRコードや通信経路での情報漏洩リスクを最小化しています。暗号化キーは登録時に一度だけ生成され、患者とシステムの紐づけに使用されます。

QRコードには有効期限が設定されており、設定ファイルで指定された時間(例: 24時間)を超過したQRコードは使用できません。これにより、古いQRコードの不正使用を防止します。

クラウドとクライアント間の通信は暗号化され、第三者による傍受や改ざんを防ぎます。また、LINEとの通信にはLINE Messaging APIの公式SDKを使用し、LINEが提供するセキュリティ機能を活用します。

## 運用上の注意事項

システムを安全かつ効果的に運用するために、以下の点に注意が必要です。

QRコードを印刷した用紙は患者本人に直接渡し、他の患者の目に触れないよう配慮します。待合室での配布は避け、診察室内または受付カウンターで個別に手渡すことを推奨します。

患者がスマートフォンを持っていない場合や、LINEを使用していない場合は、従来の呼び出し方法を併用します。本システムは既存の呼び出し方法を完全に置き換えるものではなく、補助的な手段として位置づけます。

定期的にLinkdPatientテーブルを確認し、長期間使用されていない紐づけ情報は削除することを推奨します。これにより、データベースの肥大化を防ぎ、システムのパフォーマンスを維持できます。

システムの設定ファイルには、QRコードの有効期限、メッセージのテンプレート、LINE APIの認証情報などが含まれます。これらの情報は適切に管理し、定期的にバックアップを取得します。
